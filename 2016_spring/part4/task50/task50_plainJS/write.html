<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>填写问卷</title>
    <link rel="stylesheet" href="styles/main.css">
</head>

<body>
    <header class='header'>
        <img src="./imgs/log_50x50.png" />
        <h3>问卷管理</h3>
        <a href="index.html"><span>我的问卷</span></a>
    </header>
    <section>
        <div class='detail'>
            <div class="edit-header" id="edit-header">
                <span id="write_subject">标题</span>
            </div>
            <div id="content_area">
                <!-- <div class="questions">
                    <div class="radio">
                    	<span>Q1</span>
                    	<span>单选题</span>
                    	<span>单选标题</span>
                    </div>
                    <div>
                        <div class="radios">
                            <input type="radio" name="radio0.5331434061315623" />
                            <span>单选内容</span>
                        </div>
                        <div class="radios">
                            <input type="radio" name="radio0.5331434061315623" />
                            <span>单选内容</span>
                        </div>
                        <div class="radios">
                            <input type="radio" name="radio0.5331434061315623" />
                            <span>单选内容</span>
                        </div>
                    </div>
                </div>
                <div class="questions">
                    <div class="checkbox">
                    	<span>Q2</span>
                    	<span>多选题</span>
                    	<span>多选标题</span>
                    </div>
                    <div>
                        <div class="checkboxs">
                            <input type="checkbox" />
                            <span>多选内容</span>
                        </div>
                        <div class="checkboxs">
                            <input type="checkbox" />
                            <span>多选内容</span>
                        </div>
                        <div class="checkboxs">
                            <input type="checkbox" />
                            <span>多选内容</span>
                        </div>
                    </div>
                </div>
                <div class="questions">
	                <div class="textarea">
		                <span>Q3</span>
		                <span>文本题</span>
		                <span>文本标题</span>
		                <span>此题必填</span>
	                </div>
	                <div>
	                	<textarea cols="100" rows="10" placeholder="请填写你的回答" class="textareas"></textarea>
	                </div>
                </div> -->
        	</div>
        	<input type="button" value="提交问卷" onclick="saveObj()" />
        </div>
    </section>
    <script type="text/javascript">
    	var request;
    	var requestInfo = decodeURI(location.search.substring(9));
    	request = indexedDB.open('Questionaire', 1); //打开(创建)数据库

    	request.onerror = function(event) {
    	    alert("创建/打开数据库失败，失败MSG：" + event.target.error.message);
    	    return
    	}
    	request.onsuccess = function(event) {
    	    console.log("创建/打开数据库成功");

    	    db = event.target.result;

    	    var transaction = db.transaction('myQuestionaire','readwrite');
    	    var store = transaction.objectStore('myQuestionaire');
    	    var req = store.openCursor();

    	    var stateText = "",stateClass = "";

    	    var html="",html1="",html2="",html3="";
    	    req.onsuccess = function(event){
    	    	document.getElementById("write_subject").innerHTML = requestInfo;//改标题
    	    	console.log("游标遍历");
    	    	var cursor = event.target.result;
    	    	if(cursor){
    	    		
    	    		if(cursor.key==requestInfo){//如果是当前传入的标题就渲染该数据
    	    			console.log("当前标题"+cursor.value.subject);
    	    			var allData = cursor.value.allData;
    	    			
    	    			for(var i=0;i<allData.length;i++){

    	    				switch(allData[i].type){
    	    					case "radio":
    	    					html +="<div class='questions'><div class='"+allData[i].type+"'><span>"+allData[i].name+"</span><span>单选题</span><span class='subject'>"+allData[i].subject+"</span></div><div id='"+allData[i].name+"'>";
    	    					break;
    	    					case "checkbox":
    	    					html +="<div class='questions'><div class='"+allData[i].type+"'><span>"+allData[i].name+"</span><span>多选题</span><span class='subject'>"+allData[i].subject+"</span></div><div id='"+allData[i].name+"'>";
    	    					break;
    	    					case "textarea":
    	    					html +="<div class='questions'><div class='"+allData[i].type+"'><span>"+allData[i].name+"</span><span>文本题</span><span class='subject'>"+allData[i].subject+"</span></div><div id='"+allData[i].name+"'>";
    	    					break;
    	    					default:
    	    					console.log("见了鬼");
    	    					break;
    	    				}	

    	    				for(var j=0;j<allData[i].data.length;j++){
    	    					switch(allData[i].type){
    	    						case "radio":
    	    						html += "<div class='"+allData[i].type+"s'><input type='"+allData[i].type+"' name='"+allData[i].data[j].randomNumberId+"'/><span>"+allData[i].data[j].content+"</span></div>"
    	    						break;
    	    						case "checkbox":
    	    						html += "<div class='"+allData[i].type+"s'><input type='"+allData[i].type+"'/><span>"+allData[i].data[j].content+"</span></div>"
    	    						break;
    	    						case "textarea":

    	    						var mark = "",judge;
    	    						if(allData[i].data[j].status){//是否必须填
    	    							mark="该题为必填";
    	    							judge=true;
    	    						}else{
    	    							mark="该题为选填";
    	    							judge=false;
    	    						}
    	    						html += "<div class='"+allData[i].type+"s'><textarea cols='100' rows='10' placeholder='请填写你的回答' class='textareas' >"+allData[i].data[j].content+"</textarea><p class='"+judge+"'>"+mark+"</p></div>"
    	    						break;
    	    						default:
    	    						console.log("见了鬼");
    	    						break;
    	    					}
    	    				}
    	    			html +="</div></div>";
    	    			}
    	    		}
					
    	    		var date = cursor.value.date;
    	    		cursor.continue();
    	    	}else{
    	    		console.log("遍历结束");
    	    		document.getElementById("content_area").innerHTML = html;
    	    		saveObj();
    	    	}
    	    }
    	}
    	request.onupgradeneeded = function(event) {
    	    console.log("版本更新了")
    	}
    	function updateDateToDB(type,subject,name,content){//更新数据,虽然只要更新一个对象，但是更新的思路只有：获取目标最根层的obj->拷贝一份修改->把修改的重新store进去
    		var request = indexedDB.open('Questionaire',1);
    		var index = (Number(name.slice(1,2))-1).toString();
    		var clonedObj={};


    		request.onerror = function(event) {
    		    alert("创建/打开数据库失败，失败MSG：" + event.target.error.message);
    		    return
    		}
    		request.onsuccess = function(event){
    			console.log("创建/打开DB成功");
    			var db = event.target.result;
    			var transaction = db.transaction("myQuestionaire",'readwrite');
    			var store = transaction.objectStore("myQuestionaire");
    			var rq = store.openCursor()
    			rq.onsuccess = function(event){
    				var cursor = event.target.result;
    				if(cursor){//开始游标遍历
    					if(cursor.value.subject==subject){//如果遍历到当前的问卷则开始处理

    						for(var i=0;i<cursor.value.allData[index].data.length;i++){
    							console.log(cursor.value.allData[index].data[i].content,content);

    							clonedObj = cursor.value;//拷贝一份
    							switch(type){
    								case "radio":
    								case "checkbox":
    								if(cursor.value.allData[index].data[i].content == content){
    									clonedObj.allData[index].data[i].count++;

    									var transaction = db.transaction("myQuestionaire", "readwrite");
    									store = transaction.objectStore("myQuestionaire");
    									var rqrq = store.get(subject)
    									rqrq.onsuccess=function(e){
    										store.put(clonedObj);
    										console.log("更新数据成功");
    									}
    								}
    								break;
    								case "textarea":
    								clonedObj.allData[index].data[i].count++;
    								clonedObj.allData[index].data[i].content = content;
    								
    								var transaction = db.transaction("myQuestionaire", "readwrite");
    								store = transaction.objectStore("myQuestionaire");
    								var rqrq = store.get(subject)
    								rqrq.onsuccess=function(e){
    									store.put(clonedObj);
    									console.log("更新数据成功");
    								}
    								break;
    								default:
    								break;
    							}
    						}
    					}
    					cursor.continue();
    				}else{
    					console.log("游标遍历结束");
    				}
    			}
    		}
    	}
    	
    	function saveObj(){
    		var data = [];
    		var collecion = document.getElementsByClassName('questions'); //把每一个Question的数据内容以OBJ的形式储存到DATA数组中
    		var type="";
    		for (var i = 0; i < collecion.length; i++) {

    		    // perObj.name = collecion[i].firstElementChild.firstElementChild.innerHTML;//问题的序号 Q1、Q2、Q3···
    		    // console.log()
    		   	type = collecion[i].firstElementChild.className;//问题类型

    		    // perObj.subject = collecion[i].getElementsByClassName('subject')[0].value;//分问题的标题

    		    switch (type) {
    		        case "radio":
    		            var radios = collecion[i].getElementsByClassName('radios');
    		            for (var j = 0; j < radios.length; j++) {
    		                if(radios[j].firstElementChild.checked){
    		                	updateDateToDB("radio",requestInfo,collecion[i].lastElementChild.id,radios[j].lastElementChild.innerHTML);
    		                }
    		            }
    		            break;
    		        case "checkbox":
    		            var checkboxs = collecion[i].getElementsByClassName('checkboxs');
    		            for (var j = 0; j < checkboxs.length; j++) {
    		                if(checkboxs[j].firstElementChild.checked){
    		                	updateDateToDB("checkbox",requestInfo,collecion[i].lastElementChild.id,checkboxs[j].lastElementChild.innerHTML);
    		                }
    		            }
    		            break;
    		        case "textarea":
    		            var textarea = collecion[i].getElementsByTagName('textarea')[0];
    		            
    		            if(textarea.nextElementSibling.className){
    		            	updateDateToDB("textarea",requestInfo,collecion[i].lastElementChild.id,textarea.value);
    		            }
    		            
    		            break;
    		        default:
    		            console.log("出错了！");
    		            break;
    		    }
    		}
    	}
    </script>
    <!-- <script src="script/Questionaire.js"></script> -->
</body>

</html>
